<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmer Plant Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
       document.addEventListener("DOMContentLoaded", function () {
    checkFarmerRegistration(); // ✅ Ensure registration status is checked first
    loadIoTDevices(); // ✅ Now IoT devices will also load on page load
});

function checkFarmerRegistration() {
    fetch('/rewards/farmer/check_future_registration')
    .then(response => response.json())
    .then(data => {
        console.log("DEBUG: Farmer Registration Status:", data);
        const registerSection = document.getElementById('register-future');
        const iotSection = document.getElementById('iot-registration');

        if (data.registered) {
            registerSection.style.display = 'none';  // ✅ Hide the button properly
            iotSection.style.display = 'block';  // ✅ Show IoT registration
        } else {
            registerSection.style.display = 'block';  // ✅ Show the button
            iotSection.style.display = 'none';  // ✅ Hide IoT registration
        }
    })
    .catch(error => console.error('Error checking farmer registration:', error));
}

function registerForFuture() {
    fetch('/rewards/farmer/register_future', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        console.log("Register Future Response:", data);
        alert(data.message);
        checkFarmerRegistration(); // ✅ Immediately update UI after registration
    })
    .catch(error => console.error('Error registering for Plant a Future:', error));
}



function registerIoTDevice() {
    const deviceId = document.getElementById('device-id').value.trim();

    console.log("Registering Device:", deviceId); // ✅ Debugging Log

    if (!/^\d{12}$/.test(deviceId)) {
        alert("Device ID must be exactly 12 digits.");
        return;
    }

    fetch('/rewards/farmer/register_iot_device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `device_id=${deviceId}`
    })
    .then(response => response.json())
    .then(data => {
        console.log("Server Response:", data); // ✅ Debugging Log
        alert(data.message || data.error);
        document.getElementById('device-id').value = ''; // Clear input after success
        loadIoTDevices(); // ✅ Refresh immediately after registering
    })
    .catch(error => console.error('Error registering device:', error));
}






function loadIoTDevices() {
    fetch('/rewards/get_farmer_iot_devices')
    .then(response => {
        console.log("DEBUG: Response Status -", response.status); // ✅ Debugging Log
        return response.json();
    })
    .then(data => {
        console.log("DEBUG: IoT Devices Data:", data); // ✅ Debugging Log
        if (data.error) {
            console.error("Error fetching IoT devices:", data.error);
            return;
        }

        const deviceContainer = document.getElementById('iot-devices');
        deviceContainer.innerHTML = ''; // Clear existing devices

        if (!data.devices || data.devices.length === 0) {
            deviceContainer.innerHTML = "<p>No IoT devices registered yet.</p>";
            return;
        }

        data.devices.forEach(device => {
            const deviceBox = document.createElement('div');
            deviceBox.className = "card mb-3";
            deviceBox.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">Device ID: ${device.id}</h5>
                    <p class="card-text">
                        Status:
                        <span class="text-${device.status === 'Active' ? 'success' : 'danger'}">
                            ${device.status}
                        </span>
                    </p>
                    <p class="card-text">Assigned to: ${device.assigned_user || "Available for Planting"}</p>
                </div>
            `;
            deviceContainer.appendChild(deviceBox);
        });
    })
    .catch(error => console.error('Error loading IoT devices:', error));
}





        function loadAvailableIoTDevices() {
    const farmerId = document.getElementById('farmer-select').value;
    if (!farmerId) return;

    fetch(`/rewards/get_available_iot_devices?farmer_id=${farmerId}`)
    .then(response => response.json())
    .then(data => {
        console.log("DEBUG: Received IoT Devices Data:", data);  // Debugging log
        const deviceSelect = document.getElementById('iot-device-select');
        deviceSelect.innerHTML = '<option value="">Select an IoT Device</option>';

        if (data.devices.length === 0) {
            console.log("No available IoT devices for selected farmer.");
            return;
        }

        data.devices.forEach(device => {
            deviceSelect.innerHTML += `<option value="${device.id}">${device.id} (Available)</option>`;
        });
    })
    .catch(error => console.error('Error loading IoT devices:', error));
}

    </script>
</head>
<body class="bg-light">
<!-- Header Section -->
<header class="bg-success text-white py-3 mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <!-- Logo -->
        <div class="d-flex align-items-center me-3">
            <img src="{{ url_for('static', filename='uploads/Harvest Haven.png') }}" alt="Harvest Haven Logo" style="width: 80px; height: auto;">
        </div>

        <!-- Navigation Bar -->
        <ul class="nav flex-grow-1 justify-content-center">
            {% for option in nav_options %}
            <li class="nav-item">
                <a class="nav-link text-white" href="{{ option.url }}">{{ option.name }}</a>
            </li>
            {% endfor %}
        </ul>

        <!-- Dropdown Button -->
        <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item" href="{{ url_for('profile.profile') }}">Profile</a></li>
                <li><a class="dropdown-item" href="{{ url_for('rewards.rewards') }}">Rewards</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{{ url_for('profile.logout') }}">Logout</a></li>
            </ul>
        </div>
    </div>
</header>


<!-- Register for Plant a Future Button -->
<!-- Register for Plant a Future Button -->
<div id="register-future" class="text-center">
    <button type="button" class="btn btn-primary" onclick="registerForFuture()">Register for Plant a Future</button>
</div>

<!-- IoT Device Registration (Hidden Initially) -->
<div id="iot-registration" style="display: none;">
    <div class="card mb-4">
        <div class="card-header bg-success text-white">Register a New IoT Device</div>
        <div class="card-body">
            <label for="device-id" class="form-label">Enter a 12-digit IoT Device ID:</label>
            <input type="text" id="device-id" class="form-control mb-2" maxlength="12" placeholder="Enter 12-digit ID" required>
            <button type="button" class="btn btn-success" onclick="registerIoTDevice()">Register IoT Device</button>
        </div>
    </div>

    <h3 class="text-primary">Your IoT Devices</h3>
    <div id="iot-devices">
        <!-- IoT Devices will be loaded here -->
    </div>
</div>

</main>
</body>
</html>
